<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Component Debug Test</title>
  <style>
    body {
      font-family: monospace;
      background: #1a1a1a;
      color: #fff;
      padding: 20px;
    }
    .section {
      background: #2a2a2a;
      padding: 20px;
      margin: 20px 0;
      border-radius: 8px;
    }
    .success { color: #4ade80; }
    .error { color: #ff6b6b; }
    .warning { color: #fbbf24; }
    button {
      background: #4ade80;
      color: #000;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
      font-family: monospace;
      font-size: 14px;
    }
    button:hover {
      background: #22c55e;
    }
    pre {
      background: #1a1a1a;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
  </style>
</head>
<body>
  <h1>üîç Component Debug Tool</h1>
  
  <div class="section">
    <h2>Test URLs</h2>
    <button onclick="testComponentServer()">Test Component Server (Port 3000)</button>
    <button onclick="testViteServer()">Test Vite Server (Port 5173)</button>
    <button onclick="testWebSocket()">Test WebSocket Connection</button>
    <button onclick="testFullComponent()">Open Test Component</button>
  </div>

  <div class="section">
    <h2>Server Status</h2>
    <div id="server-status">Checking...</div>
  </div>

  <div class="section">
    <h2>Dashboard State</h2>
    <div id="dashboard-state">Checking...</div>
  </div>

  <div class="section">
    <h2>Console Output</h2>
    <pre id="console-output">Waiting for tests...</pre>
  </div>

  <script>
    const log = (msg, type = 'info') => {
      const output = document.getElementById('console-output');
      const timestamp = new Date().toLocaleTimeString();
      const color = type === 'error' ? '#ff6b6b' : type === 'success' ? '#4ade80' : type === 'warning' ? '#fbbf24' : '#60a5fa';
      output.innerHTML += `<span style="color: ${color}">[${timestamp}] ${msg}</span>\n`;
      output.scrollTop = output.scrollHeight;
    };

    async function testComponentServer() {
      log('Testing component server...', 'info');
      try {
        const response = await fetch('http://localhost:3000/health');
        if (response.ok) {
          const data = await response.json();
          log(`‚úÖ Component server is running: ${data.message}`, 'success');
          document.getElementById('server-status').innerHTML = '<span class="success">‚úÖ Component Server: Online</span>';
        } else {
          log(`‚ùå Component server returned: ${response.status}`, 'error');
          document.getElementById('server-status').innerHTML = '<span class="error">‚ùå Component Server: Error</span>';
        }
      } catch (err) {
        log(`‚ùå Component server not accessible: ${err.message}`, 'error');
        document.getElementById('server-status').innerHTML = '<span class="error">‚ùå Component Server: Offline</span>';
      }
    }

    async function testViteServer() {
      log('Testing Vite server...', 'info');
      try {
        const response = await fetch('http://localhost:5173/component-renderer.html');
        if (response.ok) {
          log('‚úÖ Vite server is running', 'success');
        } else {
          log(`‚ùå Vite server returned: ${response.status}`, 'error');
        }
      } catch (err) {
        log(`‚ùå Vite server not accessible: ${err.message}`, 'error');
      }
    }

    async function testWebSocket() {
      log('Testing WebSocket connection...', 'info');
      const wsUrl = 'ws://localhost:3000';
      const socket = new WebSocket(wsUrl);

      socket.onopen = () => {
        log('‚úÖ WebSocket connected successfully', 'success');
      };

      socket.onmessage = (event) => {
        try {
          const message = JSON.parse(event.data);
          if (message.type === 'initialState') {
            const state = message.data;
            log(`‚úÖ Received initialState:`, 'success');
            log(`  - Telemetry: ${state.telemetry ? 'present' : 'MISSING'}`, state.telemetry ? 'success' : 'warning');
            log(`  - Session: ${state.sessionData ? 'present' : 'MISSING'}`, state.sessionData ? 'success' : 'warning');
            log(`  - IsRunning: ${state.isRunning}`, 'info');
            setTimeout(() => socket.close(), 1000);
          }
        } catch (e) {
          log(`Error parsing message: ${e.message}`, 'error');
        }
      };

      socket.onerror = (err) => {
        log(`‚ùå WebSocket connection failed`, 'error');
      };

      setTimeout(() => {
        if (socket.readyState !== WebSocket.OPEN) {
          log('‚è±Ô∏è WebSocket connection timeout', 'warning');
          socket.close();
        }
      }, 6000);
    }

    async function getDashboardState() {
      log('Fetching dashboard state...', 'info');
      try {
        const response = await fetch('http://localhost:3000/debug/dashboard');
        if (response.ok) {
          const data = await response.json();
          log(`Dashboard info:`, 'info');
          log(`  - Has dashboard: ${data.hasDashboard}`, data.hasDashboard ? 'success' : 'warning');
          log(`  - Widget count: ${data.widgetCount}`, 'info');
          if (data.widgets && data.widgets.length > 0) {
            log(`  - Widgets:`, 'info');
            data.widgets.forEach(w => {
              log(`    ‚Ä¢ ${w.id}: ${w.hasConfig ? w.configKeys.length + ' config keys' : 'no config'}`, 'info');
            });
          }
          document.getElementById('dashboard-state').innerHTML = `
            <div>
              <p><strong>Has Dashboard:</strong> ${data.hasDashboard ? '<span class="success">Yes</span>' : '<span class="error">No</span>'}</p>
              <p><strong>Widgets:</strong> ${data.widgetCount}</p>
              ${data.widgets ? `<pre>${JSON.stringify(data.widgets, null, 2)}</pre>` : ''}
            </div>
          `;
        } else {
          log(`‚ùå Failed to fetch dashboard: ${response.status}`, 'error');
        }
      } catch (err) {
        log(`‚ùå Error fetching dashboard: ${err.message}`, 'error');
      }
    }

    function testFullComponent() {
      log('Opening test component in new window...', 'info');
      window.open('http://localhost:3000/component/standings', '_blank');
    }

    // Auto-run tests on load
    window.addEventListener('load', () => {
      log('=== Starting automatic tests ===', 'info');
      setTimeout(() => testComponentServer(), 500);
      setTimeout(() => testViteServer(), 1500);
      setTimeout(() => getDashboardState(), 2500);
      setTimeout(() => testWebSocket(), 3500);
    });
  </script>
</body>
</html>
